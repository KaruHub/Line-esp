-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

-- Local Player
local LocalPlayer = Players.LocalPlayer

-- ESP Settings
local ESPEnabled = false
local ESPObjects = {}

-- Function to create ESP for a player
local function CreateESP(player)
    -- Check if the player has a character
    local character = player.Character
    if not character then return end

    -- Create Drawing objects for the box and tracer
    local Box = Drawing.new("Square")
    local Tracer = Drawing.new("Line")

    -- Configure the box
    Box.Visible = false
    Box.Color = Color3.new(1, 0, 0) -- Red color
    Box.Thickness = 2
    Box.Filled = false

    -- Configure the tracer
    Tracer.Visible = false
    Tracer.Color = Color3.new(1, 1, 1) -- White color
    Tracer.Thickness = 2

    -- Store the Drawing objects in the ESPObjects table
    ESPObjects[player] = {Box = Box, Tracer = Tracer}
end

-- Function to remove ESP for a player
local function RemoveESP(player)
    if ESPObjects[player] then
        ESPObjects[player].Box:Remove()
        ESPObjects[player].Tracer:Remove()
        ESPObjects[player] = nil
    end
end

-- Function to update the ESP visuals (tracers and boxes)
local function UpdateESP()
    for player, esp in pairs(ESPObjects) do
        local character = player.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local rootPart = character.HumanoidRootPart
            local position, onScreen = Camera:WorldToViewportPoint(rootPart.Position)

            if onScreen then
                -- Update the tracer line
                esp.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y) -- Bottom center of the screen
                esp.Tracer.To = Vector2.new(position.X, position.Y) -- Player's position
                esp.Tracer.Visible = ESPEnabled

                -- Update the box (optional, if you want to keep it)
                local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
                local size = (rootPart.Size.Y * 2) * (Camera.ViewportSize.Y / distance)
                esp.Box.Size = Vector2.new(size, size * 1.5)
                esp.Box.Position = Vector2.new(position.X - size / 2, position.Y - size * 1.5 / 2)
                esp.Box.Visible = ESPEnabled
            else
                -- If the player is off-screen, hide the ESP
                esp.Tracer.Visible = false
                esp.Box.Visible = false
            end
        else
            -- If the character no longer exists, remove the ESP
            RemoveESP(player)
        end
    end
end

-- Function to refresh all players (recreate ESP for new players, remove for players who left)
local function RefreshPlayers()
    local currentPlayers = Players:GetPlayers()
    for _, player in ipairs(currentPlayers) do
        if player ~= LocalPlayer and not ESPObjects[player] then
            CreateESP(player)
        end
    end

    -- Remove ESP for players who left
    for player in pairs(ESPObjects) do
        if not table.find(currentPlayers, player) then
            RemoveESP(player)
        end
    end
end

-- Toggle ESP with the "E" key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.E then
        ESPEnabled = not ESPEnabled
        for _, esp in pairs(ESPObjects) do
            esp.Tracer.Visible = ESPEnabled
            esp.Box.Visible = ESPEnabled
        end
    end
end)

-- Initial ESP creation for existing players
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end

-- Add ESP for new players
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end)

-- Remove ESP for leaving players
Players.PlayerRemoving:Connect(function(player)
    RemoveESP(player)
end)

-- Update ESP visuals every 0.1 seconds
while true do
    if ESPEnabled then
        UpdateESP()
    end
    wait(0.1) -- Update every 0.1 seconds
end

-- Refresh all players every 3 seconds
while true do
    RefreshPlayers()
    wait(3) -- Refresh every 3 seconds
end
