-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

-- Local Player
local LocalPlayer = Players.LocalPlayer

-- ESP Settings
local ESPEnabled = false
local ESPObjects = {}

-- Function to create ESP for a player
local function CreateESP(player)
    -- Check if the player has a character
    local character = player.Character
    if not character then return end

    -- Create Drawing objects for the box and tracer
    local Box = Drawing.new("Square")
    local Tracer = Drawing.new("Line")

    -- Configure the box
    Box.Visible = false
    Box.Color = Color3.new(1, 0, 0) -- Red color
    Box.Thickness = 2
    Box.Filled = false

    -- Configure the tracer
    Tracer.Visible = false
    Tracer.Color = Color3.new(1, 1, 0) -- Yellow color
    Tracer.Thickness = 2

    -- Store the Drawing objects in the ESPObjects table
    ESPObjects[player] = {Box = Box, Tracer = Tracer}

    -- Function to update the ESP
    local function UpdateESP()
        -- Check if the character and HumanoidRootPart still exist
        if not character or not character:FindFirstChild("HumanoidRootPart") then
            Box:Remove()
            Tracer:Remove()
            ESPObjects[player] = nil
            return
        end

        -- Get the position of the player's HumanoidRootPart
        local rootPart = character.HumanoidRootPart
        local position, onScreen = Camera:WorldToViewportPoint(rootPart.Position)

        -- If the player is on the screen, update the ESP
        if onScreen then
            -- Calculate the size of the box based on the player's distance from the camera
            local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
            local size = (rootPart.Size.Y * 2) * (Camera.ViewportSize.Y / distance)

            -- Update the box
            Box.Size = Vector2.new(size, size * 1.5)
            Box.Position = Vector2.new(position.X - size / 2, position.Y - size * 1.5 / 2)
            Box.Visible = ESPEnabled

            -- Update the tracer (360Â° effect)
            Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y) -- Bottom center of the screen
            Tracer.To = Vector2.new(position.X, position.Y) -- Player's position
            Tracer.Visible = ESPEnabled
        else
            -- If the player is off-screen, hide the ESP
            Box.Visible = false
            Tracer.Visible = false
        end
    end

    -- Connect the UpdateESP function to RenderStepped
    RunService.RenderStepped:Connect(UpdateESP)
end

-- Function to remove ESP for a player
local function RemoveESP(player)
    if ESPObjects[player] then
        ESPObjects[player].Box:Remove()
        ESPObjects[player].Tracer:Remove()
        ESPObjects[player] = nil
    end
end

-- Toggle ESP with the "E" key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.E then
        ESPEnabled = not ESPEnabled
        for player, esp in pairs(ESPObjects) do
            esp.Box.Visible = ESPEnabled
            esp.Tracer.Visible = ESPEnabled
        end
    end
end)

-- Add ESP for existing players
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end

-- Add ESP for new players
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end)

-- Remove ESP for leaving players
Players.PlayerRemoving:Connect(function(player)
    RemoveESP(player)
end)

-- Refresh players every 3 seconds
while true do
    wait(3)
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            -- Check if the player's character is reset and re-create ESP if necessary
            if not ESPObjects[player] or not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
                RemoveESP(player)
                CreateESP(player)
            end
        end
    end
end
