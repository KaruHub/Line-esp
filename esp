-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

-- Local Player
local LocalPlayer = Players.LocalPlayer

-- ESP Settings
local ESPEnabled = false
local ESPObjects = {}

-- Function to create ESP for a player
local function CreateESP(player)
    local character = player.Character
    if not character then return end
    local Box = Drawing.new("Square")
    local Tracer = Drawing.new("Line")
    Box.Visible = false
    Box.Color = Color3.new(1, 0, 0) 
    Box.Thickness = 2
    Box.Filled = false
    Tracer.Visible = false
    Tracer.Color = Color3.new(1, 1, 1)
    Tracer.Thickness = 2
    ESPObjects[player] = {Box = Box, Tracer = Tracer}
end

-- Function to remove ESP for a player
local function RemoveESP(player)
    if ESPObjects[player] then
        ESPObjects[player].Box:Remove()
        ESPObjects[player].Tracer:Remove()
        ESPObjects[player] = nil
    end
end

-- Function to update the ESP visuals
local function UpdateESP()
    for player, esp in pairs(ESPObjects) do
        local character = player.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            local rootPart = character.HumanoidRootPart
            local position, onScreen = Camera:WorldToViewportPoint(rootPart.Position)

            if onScreen then
                esp.Tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                esp.Tracer.To = Vector2.new(position.X, position.Y)
                esp.Tracer.Visible = ESPEnabled

                local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
                local size = (rootPart.Size.Y * 2) * (Camera.ViewportSize.Y / distance)
                esp.Box.Size = Vector2.new(size, size * 1.5)
                esp.Box.Position = Vector2.new(position.X - size / 2, position.Y - size * 1.5 / 2)
                esp.Box.Visible = ESPEnabled
            else
                esp.Tracer.Visible = false
                esp.Box.Visible = false
            end
        else
            RemoveESP(player)
        end
    end
end

-- Function to refresh all players
local function RefreshPlayers()
    local currentPlayers = Players:GetPlayers()
    for _, player in ipairs(currentPlayers) do
        if player ~= LocalPlayer and not ESPObjects[player] then
            CreateESP(player)
        end
    end

    for player in pairs(ESPObjects) do
        if not table.find(currentPlayers, player) then
            RemoveESP(player)
        end
    end
end

-- Toggle ESP with the "E" key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.E then
        ESPEnabled = not ESPEnabled
        for _, esp in pairs(ESPObjects) do
            esp.Tracer.Visible = ESPEnabled
            esp.Box.Visible = ESPEnabled
        end
    end
end)

-- Initial ESP creation for existing players
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end

-- Add ESP for new players
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        CreateESP(player)
    end
end)

-- Remove ESP for leaving players
Players.PlayerRemoving:Connect(function(player)
    RemoveESP(player)
end)

-- Update ESP visuals every 0.1 seconds
RunService.Heartbeat:Connect(function()
    if ESPEnabled then
        UpdateESP()
    end
end)

-- Refresh all players every 0.1 seconds
RunService.Heartbeat:Connect(function()
    RefreshPlayers()
end)
